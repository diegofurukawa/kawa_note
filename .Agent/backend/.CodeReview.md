# CODE REVIEW — BACKEND

## Herança Global
Este arquivo **estende** `/.Agent/.CodeReview.md` com critérios específicos para backend.

---

## Checklist Obrigatório

### Estrutura e Organização
- [ ] Código segue padrão MVC (Controller → Service → Repository).
- [ ] Arquivo está no diretório correto (`src/modules/<entity>/`).
- [ ] Nomenclatura segue convenções (`*.controller.js`, `*.service.js`, etc.).

### Validação e Tipagem
- [ ] Entrada validada com Zod em controllers.
- [ ] Schema Zod definido em `<entity>.schema.js`.
- [ ] JSDoc presente em funções públicas.
- [ ] Tipos de retorno documentados.

### Segurança
- [ ] Sem exposição de chaves ou senhas.
- [ ] Sem `process.env` direto (usar `src/config/env.js`).
- [ ] Autenticação verificada em rotas protegidas.
- [ ] Autorização verificada (usuário pode acessar recurso?).
- [ ] Sem SQL injection (usar Prisma, nunca queries raw).

### Tratamento de Erros
- [ ] Try/catch ou `.catch()` em operações assíncronas.
- [ ] Erros logados com contexto (logger.error).
- [ ] Status HTTP apropriado (400, 401, 403, 404, 500).
- [ ] Mensagem de erro não expõe detalhes internos.

### Performance
- [ ] Queries Prisma usam `.select()` para campos necessários.
- [ ] Sem N+1 queries (usar `.include()` ou `.select()` com relações).
- [ ] Paginação implementada em endpoints que retornam listas.
- [ ] Índices Prisma em campos de busca frequente.

### Logging
- [ ] Sem `console.log` (usar logger Pino).
- [ ] Logs em níveis apropriados (debug, info, warn, error).
- [ ] Contexto relevante incluído em logs.

### Linting e Qualidade
- [ ] Sem variáveis não utilizadas.
- [ ] Sem importações não utilizadas.
- [ ] Código passa em `npm run lint` (backend).
- [ ] Sem comentários de código comentado.

### Testes
- [ ] Testes unitários para lógica crítica.
- [ ] Testes de integração para endpoints.
- [ ] Cobertura mínima 80% para funções críticas.
- [ ] Testes passam em `npm run test` (backend).

### Banco de Dados
- [ ] Migrations criadas via Prisma CLI.
- [ ] Migrations nunca modificadas após execução.
- [ ] Schema Prisma atualizado.
- [ ] Relações definidas explicitamente.

### Documentação
- [ ] README atualizado se houver mudanças de API.
- [ ] Comentários explicam lógica complexa.
- [ ] Exemplos de uso em JSDoc.

---

## Critérios de Severidade

### CRITICAL (Bloqueia Execução)
- Quebra de build ou testes.
- Exposição de dados sensíveis.
- SQL injection ou vulnerabilidade de segurança.
- Erro de lógica que quebra funcionalidade existente.
- Migrations modificadas após execução.

### MAJOR (Requer Correção)
- Violação de convenções MVC.
- Falta de validação Zod.
- Tratamento de erro inadequado.
- Sem testes para lógica crítica.
- Performance degradada (N+1 queries).

### MINOR (Opcional)
- Sugestões de estilo.
- Otimizações leves.
- Melhorias de documentação.
- Refatoração de código legível.

---

## Formato de Relatório de Revisão

Cada execução deve gerar relatório em `/.Agent/.plans/reports/REPORT-<date>-backend.md`:

```markdown
# Code Review Report — Backend

## Resumo
- Arquivos modificados: N
- Status: ✅ Sucesso / ❌ Erro
- Severidade máxima: CRITICAL / MAJOR / MINOR

## Arquivos Modificados
- `backend/src/modules/notes/notes.controller.js` — ✅ Aprovado
- `backend/src/modules/notes/notes.service.js` — ✅ Aprovado
- `backend/prisma/schema.prisma` — ✅ Aprovado

## Checklist de Revisão
- [x] Estrutura MVC
- [x] Validação Zod
- [x] Segurança
- [x] Tratamento de erros
- [x] Logging
- [x] Linting
- [x] Testes
- [x] Banco de dados

## Problemas Encontrados
Nenhum.

## Recomendações
Nenhuma.

## Evidências
- Lint: ✅ `npm run lint` passou
- Testes: ✅ `npm run test` passou
- Build: ✅ `npm run build` passou
```

---

## Processo de Revisão
1. **Auditoria:** Verificar cada arquivo contra checklist.
2. **Classificação:** Atribuir severidade (CRITICAL, MAJOR, MINOR).
3. **Bloqueio:** Se CRITICAL, bloquear execução.
4. **Relatório:** Gerar relatório com evidências.
5. **Aprovação:** Aguardar confirmação do usuário.

---

## Checklist de Conformidade
- [ ] Todos os critérios CRITICAL foram verificados.
- [ ] Todos os critérios MAJOR foram verificados.
- [ ] Relatório foi gerado.
- [ ] Evidências de testes incluídas.
