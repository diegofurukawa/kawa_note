# CODE CONVENTIONS — BACKEND

## Herança Global
Este arquivo **estende** `/.Agent/.CodeConventions.md` com regras específicas para backend.

**Nenhuma regra aqui afroxa as convenções globais.**

---

## Padrões de Linguagem e Framework
- **Linguagem:** JavaScript (ESNext)
- **Runtime:** Node.js 20 LTS
- **Framework:** Fastify 4
- **ORM:** Prisma 5
- **Validação:** Zod
- **Autenticação:** JWT + bcrypt

---

## Organização de Arquivos
```
backend/
├── src/
│   ├── app.js                 # Configuração Fastify
│   ├── server.js              # Entry point
│   ├── config/
│   │   ├── database.js        # Conexão Prisma
│   │   └── env.js             # Variáveis de ambiente
│   ├── middleware/
│   │   ├── auth.middleware.js # JWT + autenticação
│   │   └── error.middleware.js # Tratamento de erros
│   ├── modules/
│   │   ├── auth/
│   │   │   ├── auth.controller.js
│   │   │   ├── auth.routes.js
│   │   │   ├── auth.schema.js (Zod)
│   │   │   └── auth.service.js
│   │   ├── notes/
│   │   ├── folders/
│   │   ├── relations/
│   │   └── apps/
│   └── utils/
│       ├── logger.js          # Pino
│       └── response.js        # Formatação de resposta
├── prisma/
│   ├── schema.prisma          # Modelo de dados
│   ├── seed.js                # Seed de dados
│   └── migrations/            # Histórico de migrations
└── package.json
```

---

## Regras de Código (ESLint)
- **Variáveis não utilizadas:** Devem ser removidas ou prefixadas com `_`.
- **Importações:** Usar plugin `unused-imports`.
- **Async/Await:** Preferir async/await sobre Promises.
- **Erros:** Sempre usar try/catch ou `.catch()` em Promises.
- **Logging:** Usar `logger` (Pino) em vez de `console.log`.

---

## Convenções de Nomenclatura
- **Arquivos de Controlador:** `<entity>.controller.js` (ex: `auth.controller.js`)
- **Arquivos de Serviço:** `<entity>.service.js` (ex: `auth.service.js`)
- **Arquivos de Rota:** `<entity>.routes.js` (ex: `auth.routes.js`)
- **Arquivos de Schema:** `<entity>.schema.js` (ex: `auth.schema.js`)
- **Funções:** camelCase (ex: `getUserById`)
- **Constantes:** UPPER_SNAKE_CASE (ex: `MAX_RETRIES`)
- **Variáveis:** camelCase (ex: `userData`)

---

## Padrão MVC (Módulos)
Cada módulo deve seguir:

### Controller
```javascript
// Responsável por receber requisições e chamar serviços
export const createNote = async (request, reply) => {
  const { title, content } = request.body;
  const note = await noteService.create({ title, content });
  return reply.code(201).send(note);
};
```

### Service
```javascript
// Lógica de negócio
export const create = async (data) => {
  const validated = noteSchema.parse(data);
  return prisma.note.create({ data: validated });
};
```

### Routes
```javascript
// Definição de endpoints
export default async (fastify) => {
  fastify.post('/notes', createNote);
  fastify.get('/notes/:id', getNote);
};
```

### Schema (Zod)
```javascript
// Validação de entrada
export const createNoteSchema = z.object({
  title: z.string().min(1),
  content: z.string(),
});
```

---

## Validação com Zod
- **Sempre validar entrada:** Usar schemas Zod em controllers.
- **Mensagens de erro:** Customizar com `.describe()` ou `.refine()`.
- **Reutilizar schemas:** Definir em `<entity>.schema.js`.

---

## Autenticação e Segurança
- **JWT:** Usar `request.user` (injetado por middleware).
- **Senhas:** Sempre usar bcrypt (nunca armazenar em plain text).
- **Variáveis sensíveis:** Usar `process.env` via `src/config/env.js`.
- **CORS:** Configurar explicitamente em `app.js`.

---

## Tratamento de Erros
- **Middleware de erro:** Centralizar em `src/middleware/error.middleware.js`.
- **Status HTTP:** Usar códigos apropriados (400, 401, 403, 404, 500).
- **Resposta de erro:** Formato consistente com `src/utils/response.js`.

---

## Logging
- **Logger:** Usar Pino (já configurado).
- **Níveis:** `debug`, `info`, `warn`, `error`.
- **Exemplo:**
  ```javascript
  logger.info({ userId: 123 }, 'User created');
  logger.error({ error }, 'Failed to create user');
  ```

---

## Prisma
- **Migrations:** Criar via `npx prisma migrate dev --name <name>`.
- **Seed:** Usar `backend/prisma/seed.js` para dados iniciais.
- **Relações:** Definir explicitamente em `schema.prisma`.
- **Índices:** Adicionar para campos frequentemente consultados.

---

## Testes
- **Framework:** Vitest + Supertest
- **Padrão:** `<entity>.test.js` no mesmo diretório.
- **Cobertura:** Mínimo 80% para funções críticas.

---

## Performance
- **Queries:** Usar `.select()` para retornar apenas campos necessários.
- **Paginação:** Implementar em endpoints que retornam listas.
- **Cache:** Considerar Redis para dados frequentemente consultados.
- **Índices:** Adicionar em `schema.prisma` para campos de busca.

---

## Documentação
- **JSDoc:** Documentar funções públicas.
- **Exemplo:**
  ```javascript
  /**
   * Cria uma nova nota
   * @param {Object} data - Dados da nota
   * @param {string} data.title - Título
   * @param {string} data.content - Conteúdo
   * @returns {Promise<Note>}
   */
  export const create = async (data) => { ... };
  ```

---

## Checklist de Conformidade
- [ ] Código segue padrão MVC
- [ ] Validação Zod em todos os controllers
- [ ] Sem `console.log` (usar logger)
- [ ] Sem variáveis não utilizadas
- [ ] Sem importações não utilizadas
- [ ] Tratamento de erro centralizado
- [ ] JSDoc em funções públicas
- [ ] Testes para lógica crítica
- [ ] Migrations versionadas
- [ ] Sem exposição de variáveis sensíveis
