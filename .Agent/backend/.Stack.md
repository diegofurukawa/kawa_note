# TECHNOLOGY STACK — BACKEND

## Herança Global
Este arquivo **especializa** `/.Agent/.Stack.md` com detalhes específicos do backend.

---

## Core Runtime
- **Node.js:** 20 LTS (Alpine)
- **Package Manager:** npm
- **Engine:** Fastify 4.28.1

---

## Framework e Servidor
- **Fastify:** 4.28.1
  - Rápido, eficiente, com suporte a plugins
  - Configuração em `backend/src/app.js`
  - Middleware em `backend/src/middleware/`

---

## Banco de Dados
- **PostgreSQL:** 16 (Alpine)
- **ORM:** Prisma 5.x
  - Schema em `backend/prisma/schema.prisma`
  - Migrations em `backend/prisma/migrations/`
  - Seed em `backend/prisma/seed.js`

---

## Validação e Tipagem
- **Zod:** 3.x
  - Schemas em `backend/src/modules/<entity>/<entity>.schema.js`
  - Validação em controllers
  - Mensagens de erro customizáveis

---

## Autenticação e Segurança
- **JWT:** Tokens JWT para autenticação stateless
- **bcrypt:** Hashing de senhas
- **Middleware:** `backend/src/middleware/auth.middleware.js`

---

## Logging
- **Pino:** Logger estruturado
- **Configuração:** `backend/src/utils/logger.js`
- **Níveis:** debug, info, warn, error

---

## Testes
- **Vitest:** Framework de testes rápido
- **Supertest:** Testes de HTTP
- **Cobertura:** Mínimo 80% para funções críticas

---

## Docker
- **Base Image:** `node:20-alpine`
- **Multi-stage Build:**
  1. `deps` — Instala dependências
  2. `build` — Compila/prepara código
  3. `runtime` — Executa aplicação
- **Dockerfile:** `backend/Dockerfile`
- **Compose:** `backend/docker-compose.yml`

---

## Variáveis de Ambiente
- **Arquivo:** `backend/.env` (não versionado)
- **Exemplo:** `backend/.env.example`
- **Carregamento:** `backend/src/config/env.js`
- **Variáveis Críticas:**
  - `DATABASE_URL` — Conexão PostgreSQL
  - `JWT_SECRET` — Chave JWT
  - `NODE_ENV` — Ambiente (development, production)

---

## Estrutura de Módulos
Cada módulo em `backend/src/modules/<entity>/`:
- `<entity>.controller.js` — Handlers HTTP
- `<entity>.service.js` — Lógica de negócio
- `<entity>.routes.js` — Definição de rotas
- `<entity>.schema.js` — Validação Zod

### Módulos Existentes
1. **auth** — Autenticação (register, login, me, logout, refresh)
2. **notes** — Notas (CRUD + search)
3. **folders** — Pastas (CRUD + hierarchy)
4. **relations** — Relações (CRUD + graph)
5. **apps** — Aplicações (public settings)

---

## Scripts NPM
```json
{
  "dev": "node backend/src/server.js",
  "build": "npm run prisma:generate",
  "start": "node backend/src/server.js",
  "lint": "eslint backend/src --fix",
  "test": "vitest run",
  "test:watch": "vitest",
  "prisma:generate": "prisma generate",
  "prisma:migrate": "prisma migrate dev",
  "prisma:seed": "node backend/prisma/seed.js"
}
```

---

## Dependências Principais
```json
{
  "fastify": "^4.28.1",
  "prisma": "^5.x",
  "@prisma/client": "^5.x",
  "zod": "^3.x",
  "bcrypt": "^5.x",
  "jsonwebtoken": "^9.x",
  "pino": "^8.x",
  "dotenv": "^16.x"
}
```

---

## Dependências de Desenvolvimento
```json
{
  "vitest": "^1.x",
  "supertest": "^6.x",
  "eslint": "^8.x",
  "@eslint/js": "^8.x"
}
```

---

## Configuração de Ambiente
- **Desenvolvimento:** `NODE_ENV=development`
- **Produção:** `NODE_ENV=production`
- **Porta:** `3000` (padrão)
- **Database:** PostgreSQL em `10.10.0.32:5432`

---

## Checklist de Sincronização
- [ ] `backend/package.json` atualizado
- [ ] `backend/prisma/schema.prisma` atualizado
- [ ] Migrations versionadas
- [ ] Variáveis de ambiente documentadas
- [ ] Scripts NPM funcionando
- [ ] Testes passando
- [ ] Lint passando
